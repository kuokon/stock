{"version":3,"file":"Import.js","sourceRoot":"","sources":["../../../src/ot/model/Import.ts"],"names":[],"mappings":"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","sourcesContent":["module MyApp {\r\n\r\n\r\n    export class Import {\r\n\r\n        static parseRaw(svr: DbService, txt: string, isHK=true): ParseResult {\r\n\r\n            let res = new ParseResult();\r\n\r\n            console.info('isHK: ' + isHK)\r\n\r\n            let options: Option[] = [];\r\n\r\n            if (txt === null || txt === undefined) {\r\n                let msg = 'no data to import';\r\n                console.warn(msg);\r\n                txt = '';\r\n                alert(msg);\r\n                return;\r\n            }\r\n\r\n            let lines = txt.split('\\n');\r\n            let warnings = [];\r\n\r\n            console.info(' parsing lines: ' + lines.length);\r\n\r\n            for (let i = 0, len = lines.length; i < len; i++) {\r\n\r\n                let line = lines[i];\r\n\r\n                if (Helper.isBlank(line)) {\r\n                    continue;\r\n                }\r\n                let obj = Import.parseLine(svr, line, isHK);\r\n\r\n                if (obj) {\r\n                    res.parsed.push(obj);\r\n                } else {\r\n                    res.skipped.push(line);\r\n                }\r\n\r\n            }\r\n\r\n            return res;\r\n        }\r\n\r\n\r\n        // HK 代碼\t名稱\t方向\t成交數量\t成交價格\t成交金額\t對手經紀\t成交時間\r\n        // US 代碼\t名f稱\t方向\t成交數量\t成交價格\t成交金額\t成交時間\r\n        static parseLine(svr:  DbService, line, isHK=true): Option {\r\n\r\n            let res: Option = null;\r\n\r\n            let txts = line.split('\\t');\r\n\r\n            // 代碼\r\n            let sym = (txts[0] || '').trim();  // ALB201127C240000.HK\r\n            let name = (txts[1] || '').trim(); // 阿里 201127 240.00 購\r\n\r\n            // 方向\r\n            let direction = (txts[2] || '').trim();\r\n\r\n            // 成交數量\r\n            let numExecuted = (txts[3] || '').trim();\r\n            let priceExecuted =  (txts[4] || '').trim();\r\n            let amtExecuted = (txts[5] || '').trim();\r\n\r\n            // 成交時間\r\n            let idx = isHK ? 7 : 6;\r\n            let datetime =  (txts[idx] || '').trim();\r\n\r\n\r\n            // check if it's option and got executed\r\n            let num = parseInt(numExecuted);\r\n            let isOption = numExecuted.indexOf('張') >= 0;\r\n\r\n\r\n\r\n            if (num && isOption) {\r\n\r\n                // sym = 'ALB201127C240000.HK'\r\n                // sym = 'FUTU210702P167500'\r\n                res = new Option();\r\n                res.Name = name.substr(0, name.indexOf(' '));//+ name.substr(name.lastIndexOf(' '));\r\n                res.DateBought = datetime;\r\n\r\n                // ALB201127C240000.HK\r\n                let idx_base = isHK ? 3 : 4;\r\n                res.DateExp = '20' + sym.substr(idx_base, 2) + '-' + sym.substr(idx_base+2, 2) + '-' + sym.substr(idx_base+4, 2);\r\n                res.P_C = sym.substr(idx_base+6, 1);\r\n                res.Strike = parseFloat(sym.substr(idx_base+7, 3));\r\n                res.NumContract = num;\r\n\r\n\r\n                if (!(res.P_C == 'P' || res.P_C == 'C')) {\r\n                    console.warn(' P_C ' + res.P_C);\r\n                }\r\n\r\n                res.Premium = parseFloat(priceExecuted.replace(',', ''));\r\n                let amtCost = parseFloat(amtExecuted.replace(',', ''));\r\n\r\n                let stock = svr.mgr.stocks.getByKey(res.getStockSymbol());\r\n                res._stock = stock;\r\n\r\n                let calcCost = res.Premium * res.getNumShares();\r\n                if(amtCost != (calcCost)) {\r\n                    console.warn('something fishy about ! amtCost: ' + amtCost + ', calc: ' + calcCost);\r\n                }\r\n\r\n\r\n                if (!(direction == '沽空' || direction == '買入')) {\r\n                    console.warn(' option not buy/sell  direction : ' + direction);\r\n\r\n                }\r\n\r\n                if (direction == '沽空') {\r\n                    res.NumContract = -res.NumContract;\r\n                }\r\n\r\n                res.PriceAtBought = stock.Price;\r\n\r\n                // ALB201127P215000.HK\r\n            } else {\r\n                if (sym.length > 16) {\r\n                    console.warn(' maybe mis-parse!  line: ' + line);\r\n                }\r\n\r\n            }\r\n\r\n\r\n            return res;\r\n\r\n        }\r\n\r\n\r\n    }\r\n}\r\n"]}