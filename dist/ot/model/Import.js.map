{"version":3,"file":"Import.js","sourceRoot":"","sources":["../../../src/ot/model/Import.ts"],"names":[],"mappings":"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","sourcesContent":["module MyApp {\r\n\r\n\r\n    export class Import {\r\n\r\n        static parseRaw(svr: DbService, txt: string, isHK=true): ParseResult {\r\n\r\n            let res = new ParseResult();\r\n\r\n            let options: Option[] = [];\r\n\r\n            if (txt === null || txt === undefined) {\r\n                let msg = 'no data to import';\r\n                console.warn(msg);\r\n                txt = '';\r\n                alert(msg);\r\n                return;\r\n            }\r\n\r\n            let lines = txt.split('\\n');\r\n            let warnings = [];\r\n\r\n            console.info(' parsing lines: ' + lines.length);\r\n\r\n            for (let i = 0, len = lines.length; i < len; i++) {\r\n\r\n                let line = lines[i];\r\n\r\n                if (Helper.isBlank(line)) {\r\n                    continue;\r\n                }\r\n\r\n\r\n                let obj = isHK ?  Import.parseHKCSV(svr, line) : Import.parseUScsv(line);\r\n\r\n                if (obj) {\r\n                    res.parsed.push(obj);\r\n                } else {\r\n                    res.skipped.push(line);\r\n                }\r\n\r\n            }\r\n\r\n            return res;\r\n        }\r\n\r\n        static parseUScsv(line) : Option {\r\n            // 方向\t代碼\t名稱\t訂單價格\t訂單數量\t交易狀態\t已成交\t落盤時間\t訂單類型\t期限\t盤前盤後\t觸發價\t沽空\r\n            let res: Option=null;\r\n\r\n            let txts = line.split('\\t');\r\n\r\n\r\n            // 方向\r\n            let direction = txts[0] || '';\r\n\r\n            // 代碼\r\n            let sym = txts[1] || '';  // ALB201127C240000.HK\r\n            let name = txts[2] || ''; // 阿里 201127 240.00 購\r\n\r\n            // 交易狀態\r\n            let status = txts[5] || '';\r\n\r\n            // 落盤時間\r\n            let datetime = txts[7] || '';\r\n\r\n            // 訂單價格\r\n            let unitPrice =  txts[3] || '';\r\n\r\n            // 訂單數量 / 成交數量\r\n            let numExecuted = txts[4] || '';\r\n\r\n            let isOption = numExecuted.indexOf('張') >= 0;\r\n            let isSkipped = status == '已撤單';\r\n\r\n            if (isSkipped) {\r\n                return res;\r\n            }\r\n\r\n            let num = parseInt(numExecuted);\r\n\r\n            if (num && isOption) {\r\n\r\n                // sym = 'ALB201127C240000.HK'\r\n\r\n                res = new Option();\r\n                res.Name = name.substr(0, 2);//+ name.substr(name.lastIndexOf(' '));\r\n                res.DateBought = datetime;\r\n\r\n\r\n                // sym = 'FUTU210625P146000'\r\n                res.Strike = parseFloat(sym.substr(11, 3));\r\n\r\n                // sym = 'FUTU210625P146000'\r\n                let idx = 4;\r\n                res.DateExp = '20' + sym.substr(idx, 2) + '-' + sym.substr(idx+2, 2) + '-' + sym.substr(idx+4, 2);\r\n\r\n                res.NumContract = num;\r\n\r\n                //sym = 'FUTU210625P146000'\r\n                res.P_C = sym.substr(idx+6, 1);\r\n                if (!(res.P_C == 'P' || res.P_C == 'C')) {\r\n                    console.warn(' P_C ' + res.P_C);\r\n                }\r\n\r\n                res.Premium = parseFloat(unitPrice.replace(',', ''));\r\n                // res.NumShareExposed  =  res.NumContract * 100;\r\n                // res.AmtCost = res.NumShareExposed * res.Premium;\r\n                //res.AmtCost = parseFloat(amtExecuted.replace(',', ''));\r\n\r\n\r\n                //res.NumShareExposed = Math.round( res.AmtCost / res.Premium / Math.abs(res.NumContract) );\r\n                //\r\n                // if(res.NumShareExposed < 0) {\r\n                //     console.warn('#shares : exe ' + parseInt(amtExecuted) + ', premium: ' + res.Premium + ', num' + Math.abs(res.NumContract) )\r\n                // }\r\n\r\n                if (!(direction == '沽空' || direction == '買入')) {\r\n                    console.warn(' option not buy/sell  direction : ' + direction);\r\n\r\n                }\r\n\r\n                if (direction == '沽空') {\r\n                    res.NumContract = -res.NumContract;\r\n                }\r\n\r\n                // ALB201127P215000.HK\r\n\r\n\r\n            }else {\r\n                if (sym.length > 16) {\r\n                    console.warn(' maybe mis-parse!  line: ' + line);\r\n                }\r\n\r\n            }\r\n\r\n            return res;\r\n\r\n        }\r\n\r\n\r\n        // 代碼\t名稱\t方向\t訂單價格\t訂單數量\t交易狀態\t已成交@均價\t落盤時間\t訂單類型\t期限\t盤前競價\t觸發價\t沽空\t成交數量\t成交價格\t成交金額\t對手經紀\t落盤時間\t備註\r\n        // 代碼\t名稱\t方向\t成交數量\t成交價格\t成交金額\t對手經紀\t成交時間\r\n\r\n        static parseHKCSV(svr:  DbService, line): Option {\r\n\r\n            let res: Option = null;\r\n\r\n            let txts = line.split('\\t');\r\n\r\n            // 代碼\r\n            let sym = (txts[0] || '').trim();  // ALB201127C240000.HK\r\n            let name = (txts[1] || '').trim(); // 阿里 201127 240.00 購\r\n\r\n            // 方向\r\n            let direction = (txts[2] || '').trim();\r\n\r\n            // 成交數量\r\n            let numExecuted = (txts[3] || '').trim();\r\n            let priceExecuted =  (txts[4] || '').trim();\r\n            let amtExecuted = (txts[5] || '').trim();\r\n\r\n            // 成交時間\r\n            let datetime =  (txts[7] || '').trim();\r\n\r\n\r\n            // check if it's option and got executed\r\n            let num = parseInt(numExecuted);\r\n            let isOption = numExecuted.indexOf('張') >= 0;\r\n\r\n            // let isSkipped = status == '已撤單';\r\n            //\r\n            // if (isSkipped) {\r\n            //     return res;\r\n            // }\r\n\r\n\r\n            if (num && isOption) {\r\n\r\n                // sym = 'ALB201127C240000.HK'\r\n                res = new Option();\r\n                res.Name = name.substr(0, 2) ;//+ name.substr(name.lastIndexOf(' '));\r\n                res.DateBought = datetime;\r\n\r\n                // ALB201127C240000.HK\r\n                res.Strike = parseFloat(sym.substr(10, 3));\r\n\r\n                // ALB201127C240000.HK\r\n                res.DateExp = '20' + sym.substr(3, 2) + '-' + sym.substr(5, 2) + '-' + sym.substr(7, 2);\r\n\r\n                res.NumContract = num;\r\n\r\n                // ALB201127C240000.HK\r\n                res.P_C = sym.substr(9, 1);\r\n                if (!(res.P_C == 'P' || res.P_C == 'C')) {\r\n                    console.warn(' P_C ' + res.P_C);\r\n                }\r\n\r\n                res.Premium = parseFloat(priceExecuted.replace(',', ''));\r\n\r\n                let amtCost = parseFloat(amtExecuted.replace(',', ''));\r\n\r\n                //res.NumShareExposed = Math.round( amtCost / res.Premium / Math.abs(res.NumContract) );\r\n\r\n                let stock = svr.mgr.stocks.getByKey(res.getStockSymbol());\r\n                res._stock = stock;\r\n\r\n\r\n\r\n                let calcCost = res.Premium * res.getNumShares();\r\n                if(amtCost != (calcCost)) {\r\n                    console.warn('something fishy about ! amtCost: ' + amtCost + ', calc: ' + calcCost);\r\n                }\r\n\r\n\r\n                if (!(direction == '沽空' || direction == '買入')) {\r\n                    console.warn(' option not buy/sell  direction : ' + direction);\r\n\r\n                }\r\n\r\n                if (direction == '沽空') {\r\n                    res.NumContract = -res.NumContract;\r\n                }\r\n\r\n                // ALB201127P215000.HK\r\n            } else {\r\n                if (sym.length > 16) {\r\n                    console.warn(' maybe mis-parse!  line: ' + line);\r\n                }\r\n\r\n            }\r\n\r\n\r\n            return res;\r\n\r\n        }\r\n\r\n\r\n    }\r\n}\r\n"]}